// This script is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
// https://creativecommons.org/licenses/by-nc-sa/4.0/
// Â© QuantAlgo

//@version=6
indicator('Adaptive Z-Score Oscillator [QuantAlgo]', overlay=false, max_lines_count=100, max_labels_count=100)

//              â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—              //
//              â•‘      USER-DEFINED SETTINGS     â•‘              //
//              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              //

var string calc_settings = 'â•â•â•â•â•â•â•â• Calculation Settings â•â•â•â•â•â•â•â•'
var string threshold_settings = 'â•â•â•â•â•â•â•â• Threshold Settings â•â•â•â•â•â•â•â•'
var string divergence_settings = 'â•â•â•â•â•â•â•â• Divergence Settings â•â•â•â•â•â•â•â•'
var string visual_settings = 'â•â•â•â•â•â•â•â• Visualization Settings â•â•â•â•â•â•â•â•'

tooltip_length = 'Number of bars used for Z-Score calculation. Lower values (10-15) create a more responsive indicator that reacts quickly to price changes but generates more noise. Higher values (25-50) produce smoother readings with better trend identification but increased lag.'
tooltip_ma_type = 'Moving average type used for basis and smoothing calculations. EMA: Exponentially weighted, more responsive to recent data. SMA: Simple average with equal weight to all periods. WMA: Linearly weighted toward recent prices. HMA: Hull MA provides smooth output with minimal lag. VWMA: Volume-weighted for incorporating market participation.'
tooltip_smoothing = 'Additional smoothing applied to the raw Z-Score output. Higher values reduce noise and false signals but increase lag. Values of 1-3 work well for most timeframes. Use 1 for maximum responsiveness or 5+ for very smooth readings.'
tooltip_threshold_mode = 'Select threshold calculation method. Adaptive: Thresholds automatically adjust based on historical Z-Score distribution using percentile calculations, adapting to changing market volatility and regime shifts. Fixed: Uses static threshold levels based on traditional Z-Score interpretation.'
tooltip_lookback = 'Period for calculating adaptive percentile thresholds. 252 bars â‰ˆ 1 year of daily data. Longer periods provide more stable, historically-grounded thresholds. Shorter periods adapt faster to recent market conditions.'
tooltip_upper_pct = 'Percentile level for the upper threshold. A value of 85 means the threshold is positioned where 85% of historical Z-Score readings fall below. Higher values create more selective overbought signals.'
tooltip_lower_pct = 'Percentile level for the lower threshold. A value of 15 means the threshold is positioned where only 15% of historical readings fall below. Lower values create more selective oversold signals.'
tooltip_show_fixed = 'Display fixed reference threshold lines on the chart. Useful for comparing adaptive thresholds against traditional static levels and understanding how market conditions have shifted.'
tooltip_fixed_upper = 'Fixed upper threshold level. Traditional Z-Score interpretation: 2.0 represents 2 standard deviations above the mean, statistically significant in normal distributions.'
tooltip_fixed_lower = 'Fixed lower threshold level. Traditional Z-Score interpretation: -2.0 represents 2 standard deviations below the mean, indicating statistically significant downside deviation.'
tooltip_enable_div = 'Enable divergence detection. Identifies when price makes new extremes but Z-Score shows decreasing statistical deviation - a key signal of trend exhaustion and potential mean reversion. Only detects divergences in extreme zones where they are statistically meaningful.'
tooltip_pivot_length = 'Bars on each side required to confirm a price pivot. Higher values (5-10) produce more reliable pivots with fewer false signals but more lag. Lower values (2-4) detect pivots faster but may include noise. Recommended: 5 for swing trading, 3 for day trading.'
tooltip_max_pivot_lookback = 'Maximum bars between compared pivots. Too short misses valid divergences; too long compares unrelated market conditions. 40-80 bars works for most timeframes - allows 2-4 major swings to develop while maintaining relevance.'
tooltip_min_pivot_lookback = 'Minimum bars between compared pivots. Prevents comparing pivots that are too close together (noise). Should be at least 2x pivot length. Recommended: 10-20 bars to ensure distinct price swings.'
tooltip_div_strength = 'Minimum Z-Score difference required between pivots to confirm divergence. Filters weak/marginal divergences. 0.2-0.5 = sensitive (more signals, some weak), 0.5-1.0 = moderate (balanced), 1.0+ = strong (fewer but high quality signals). Set based on your threshold levels.'
tooltip_show_labels = 'Display text labels on divergences. "Bull" for bullish (price exhaustion, potential bounce), "Bear" for bearish (rally exhaustion, potential reversal). Helps quick visual identification but can clutter chart with many signals.'
tooltip_color_preset = 'Pre-configured color schemes optimized for different chart backgrounds and visual preferences. Each preset maintains strong contrast between bullish and bearish states for instant recognition.'
tooltip_bullish = 'Color for bullish/overbought readings when Z-Score exceeds upper threshold zones. Used for extreme and moderate bullish histogram bars and upper threshold lines.'
tooltip_bearish = 'Color for bearish/oversold readings when Z-Score falls below lower threshold zones. Used for extreme and moderate bearish histogram bars and lower threshold lines.'
tooltip_neutral = 'Color for neutral readings when Z-Score is between threshold zones. Used for histogram bars when the indicator is in the neutral zone.'
tooltip_bar_transparency = 'Transparency level for the Z-Score histogram bars. Lower values (0-20) create bold, prominent bars. Higher values (50-80) create subtle bars that blend with background elements.'
tooltip_candle_coloring = 'Enable coloring of price candles on the main chart based on Z-Score readings.'

length = input.int(20, 'Length', minval=2, group=calc_settings, tooltip=tooltip_length)
maType = input.string('EMA', 'MA Type', options=['SMA', 'EMA', 'WMA', 'HMA', 'VWMA'], group=calc_settings, tooltip=tooltip_ma_type)
smooth = input.int(3, 'Smoothing', minval=1, group=calc_settings, tooltip=tooltip_smoothing)

thresholdMode = input.string('Adaptive', 'Threshold Mode', options=['Adaptive', 'Fixed'], group=threshold_settings, tooltip=tooltip_threshold_mode)
percentilePeriod = input.int(252, 'Lookback Period', minval=50, group=threshold_settings, tooltip=tooltip_lookback)
upperPercentile = input.float(85, 'Adaptive Upper %', minval=50, maxval=99, step=1, group=threshold_settings, tooltip=tooltip_upper_pct)
lowerPercentile = input.float(15, 'Adaptive Lower %', minval=1, maxval=50, step=1, group=threshold_settings, tooltip=tooltip_lower_pct)
showFixed = input.bool(false, 'Show Fixed Levels', group=threshold_settings, tooltip=tooltip_show_fixed)
fixedUpper = input.float(2.0, 'Fixed Upper Level', minval=0.5, step=0.5, group=threshold_settings, tooltip=tooltip_fixed_upper)
fixedLower = input.float(-2.0, 'Fixed Lower Level', maxval=-0.5, step=0.5, group=threshold_settings, tooltip=tooltip_fixed_lower)

enableDiv = input.bool(true, 'Enable Divergences', group=divergence_settings, tooltip=tooltip_enable_div)
pivotLength = input.int(5, 'Pivot Length', minval=2, maxval=20, group=divergence_settings, tooltip=tooltip_pivot_length)
maxPivotLookback = input.int(60, 'Max Pivot Lookback', minval=20, maxval=200, group=divergence_settings, tooltip=tooltip_max_pivot_lookback)
minPivotLookback = input.int(10, 'Min Pivot Lookback', minval=5, maxval=100, group=divergence_settings, tooltip=tooltip_min_pivot_lookback)
divStrength = input.float(0.3, 'Divergence Strength Filter', minval=0.1, maxval=2.0, step=0.1, group=divergence_settings, tooltip=tooltip_div_strength)
showDivLabels = input.bool(true, 'Show Divergence Labels', group=divergence_settings, tooltip=tooltip_show_labels)

colorPreset = input.string('Custom', 'Color Preset', options=['Classic', 'Aqua', 'Cosmic', 'Ember', 'Neon', 'Custom'], group=visual_settings, tooltip=tooltip_color_preset)
bullishColorInput = input.color(#00ffaa, 'Bullish Color', group=visual_settings, tooltip=tooltip_bullish)
bearishColorInput = input.color(#ff0000, 'Bearish Color', group=visual_settings, tooltip=tooltip_bearish)
neutralColorInput = input.color(#808080, 'Neutral Color', group=visual_settings, tooltip=tooltip_neutral)
barTransparency = input.int(0, 'Bar Transparency', minval=0, maxval=90, step=10, group=visual_settings, tooltip=tooltip_bar_transparency)
enableCandleColoring = input.bool(true, 'Enable Candle Coloring', group=visual_settings, tooltip=tooltip_candle_coloring)

[bullishColor, bearishColor, neutralColor] = switch colorPreset
    'Classic' => [#00ff00, #ff0000, #808080]
    'Aqua' => [#00bfff, #ff8c00, #7f7f7f]
    'Cosmic' => [#49ffce, #9932cc, #6a5acd]
    'Ember' => [#ff6600, #00cccc, #999999]
    'Neon' => [#ffff00, #ff00ff, #00ff00]
    'Custom' => [bullishColorInput, bearishColorInput, neutralColorInput]

//              â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—              //
//              â•‘        CORE CALCULATION        â•‘              //
//              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              //

adaptive = thresholdMode == 'Adaptive'

ma(source, len, type) =>
    switch type
        'SMA' => ta.sma(source, len)
        'EMA' => ta.ema(source, len)
        'WMA' => ta.wma(source, len)
        'HMA' => ta.hma(source, len)
        'VWMA' => ta.vwma(source, len)

basis = ma(close, length, maType)
stdev = ta.stdev(close, length)
zScore = stdev != 0 ? (close - basis) / stdev : 0
smoothedZ = ma(zScore, smooth, maType)

upperThreshold = adaptive and not na(smoothedZ) ? ta.percentile_linear_interpolation(smoothedZ, percentilePeriod, upperPercentile) : fixedUpper
lowerThreshold = adaptive and not na(smoothedZ) ? ta.percentile_linear_interpolation(smoothedZ, percentilePeriod, lowerPercentile) : fixedLower

midUpper = upperThreshold / 2
midLower = lowerThreshold / 2

extremeBullish = smoothedZ >= upperThreshold
moderateBullish = smoothedZ >= midUpper and smoothedZ < upperThreshold
extremeBearish = smoothedZ <= lowerThreshold
moderateBearish = smoothedZ <= midLower and smoothedZ > lowerThreshold

enterOverbought = ta.crossover(smoothedZ, upperThreshold)
enterOversold = ta.crossunder(smoothedZ, lowerThreshold)
exitOverbought = ta.crossunder(smoothedZ, upperThreshold)
exitOversold = ta.crossover(smoothedZ, lowerThreshold)
zeroCrossUp = ta.crossover(smoothedZ, 0)
zeroCrossDown = ta.crossunder(smoothedZ, 0)

//              â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—              //
//              â•‘      DIVERGENCE DETECTION      â•‘              //
//              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              //

var bool bullishDivergence = false
var bool bearishDivergence = false

if enableDiv
    pricePivotHigh = ta.pivothigh(high, pivotLength, pivotLength)
    pricePivotLow = ta.pivotlow(low, pivotLength, pivotLength)
    
    var array<float> priceHighs = array.new<float>()
    var array<int> priceHighBars = array.new<int>()
    var array<float> zScoreAtHighs = array.new<float>()
    
    var array<float> priceLows = array.new<float>()
    var array<int> priceLowBars = array.new<int>()
    var array<float> zScoreAtLows = array.new<float>()
    
    if not na(pricePivotHigh)
        currentBar = bar_index - pivotLength
        currentPriceHigh = high[pivotLength]
        currentZScore = smoothedZ[pivotLength]
        currentThreshold = upperThreshold[pivotLength]
        
        array.push(priceHighs, currentPriceHigh)
        array.push(priceHighBars, currentBar)
        array.push(zScoreAtHighs, currentZScore)
        
        if array.size(priceHighs) > 10
            array.shift(priceHighs)
            array.shift(priceHighBars)
            array.shift(zScoreAtHighs)
        
        if currentZScore >= currentThreshold and array.size(priceHighs) > 1
            for i = array.size(priceHighs) - 2 to 0
                prevBar = array.get(priceHighBars, i)
                barsAgo = currentBar - prevBar
                
                if barsAgo >= minPivotLookback and barsAgo <= maxPivotLookback
                    prevPriceHigh = array.get(priceHighs, i)
                    prevZScore = array.get(zScoreAtHighs, i)
                    
                    isPriceHigherHigh = currentPriceHigh > prevPriceHigh
                    isZScoreLowerHigh = currentZScore < prevZScore
                    isStrongEnough = math.abs(prevZScore - currentZScore) >= divStrength
                    
                    if isPriceHigherHigh and isZScoreLowerHigh and isStrongEnough
                        line.new(prevBar, prevZScore, currentBar, currentZScore, 
                                 color=bearishColor, width=2, style=line.style_solid)
                        
                        if showDivLabels
                            label.new(currentBar, currentZScore, ' Bear ', 
                                     style=label.style_label_down, color=bearishColor, 
                                     textcolor=color.black, size=size.small,
                                     tooltip='Price: Higher High\nZ-Score: Lower High\nTrend exhaustion signal')
                        
                        bearishDivergence := true
                        break
    
    if not na(pricePivotLow)
        currentBar = bar_index - pivotLength
        currentPriceLow = low[pivotLength]
        currentZScore = smoothedZ[pivotLength]
        currentThreshold = lowerThreshold[pivotLength]
        
        array.push(priceLows, currentPriceLow)
        array.push(priceLowBars, currentBar)
        array.push(zScoreAtLows, currentZScore)
        
        if array.size(priceLows) > 10
            array.shift(priceLows)
            array.shift(priceLowBars)
            array.shift(zScoreAtLows)
        
        if currentZScore <= currentThreshold and array.size(priceLows) > 1
            for i = array.size(priceLows) - 2 to 0
                prevBar = array.get(priceLowBars, i)
                barsAgo = currentBar - prevBar
                
                if barsAgo >= minPivotLookback and barsAgo <= maxPivotLookback
                    prevPriceLow = array.get(priceLows, i)
                    prevZScore = array.get(zScoreAtLows, i)
                    
                    isPriceLowerLow = currentPriceLow < prevPriceLow
                    isZScoreHigherLow = currentZScore > prevZScore
                    isStrongEnough = math.abs(prevZScore - currentZScore) >= divStrength
                    
                    if isPriceLowerLow and isZScoreHigherLow and isStrongEnough
                        line.new(prevBar, prevZScore, currentBar, currentZScore, 
                                 color=bullishColor, width=2, style=line.style_solid)
                        
                        if showDivLabels
                            label.new(currentBar, currentZScore, ' Bull ', 
                                     style=label.style_label_up, color=bullishColor, 
                                     textcolor=color.black, size=size.small,
                                     tooltip='Price: Lower Low\nZ-Score: Higher Low\nTrend exhaustion signal')
                        
                        bullishDivergence := true
                        break

//              â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—              //
//              â•‘         VISUALIZATION          â•‘              //
//              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              //

color barColor = switch
    extremeBullish => color.new(bullishColor, barTransparency)
    moderateBullish => color.new(bullishColor, barTransparency + 40)
    extremeBearish => color.new(bearishColor, barTransparency)
    moderateBearish => color.new(bearishColor, barTransparency + 40)
    => color.new(neutralColor, 40)

barcolor(enableCandleColoring ? barColor : na, title='Z-Score Candle Coloring')

plot(smoothedZ, 'Z-Score', color=barColor, style=plot.style_columns, linewidth=2)
hline(0, 'Zero', color=color.white, linestyle=hline.style_dashed, linewidth=1)

plot(upperThreshold, 'Upper Threshold', color=bearishColor, linewidth=2, style=plot.style_line)
plot(lowerThreshold, 'Lower Threshold', color=bullishColor, linewidth=2, style=plot.style_line)

plot(showFixed ? fixedUpper : na, 'Fixed Upper', color=color.new(bearishColor, 50), linewidth=1, style=plot.style_line)
plot(showFixed ? fixedLower : na, 'Fixed Lower', color=color.new(bullishColor, 50), linewidth=1, style=plot.style_line)

//              â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—              //
//              â•‘             ALERTS             â•‘              //
//              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              //

alertcondition(enterOverbought, title='Enter Overbought', message='Z-Score Oscillator: Entered OVERBOUGHT zone {{exchange}}:{{ticker}} - {{interval}}')
alertcondition(enterOversold, title='Enter Oversold', message='Z-Score Oscillator: Entered OVERSOLD zone {{exchange}}:{{ticker}} - {{interval}}')
alertcondition(exitOverbought, title='Exit Overbought', message='Z-Score Oscillator: Exited OVERBOUGHT zone {{exchange}}:{{ticker}} - {{interval}}')
alertcondition(exitOversold, title='Exit Oversold', message='Z-Score Oscillator: Exited OVERSOLD zone {{exchange}}:{{ticker}} - {{interval}}')
alertcondition(zeroCrossUp, title='Zero Cross Up', message='Z-Score Oscillator: Crossed ABOVE zero line {{exchange}}:{{ticker}} - {{interval}}')
alertcondition(zeroCrossDown, title='Zero Cross Down', message='Z-Score Oscillator: Crossed BELOW zero line {{exchange}}:{{ticker}} - {{interval}}')
alertcondition(enterOverbought or enterOversold, title='Extreme Zone Entry', message='Z-Score Oscillator: Entered EXTREME zone - Check chart {{exchange}}:{{ticker}} - {{interval}}')
alertcondition(bullishDivergence, title='Bullish Divergence', message='Z-Score: BULLISH Divergence - Price lower low but less oversold, potential reversal {{exchange}}:{{ticker}} - {{interval}}')
alertcondition(bearishDivergence, title='Bearish Divergence', message='Z-Score: BEARISH Divergence - Price higher high but less overbought, potential reversal {{exchange}}:{{ticker}} - {{interval}}')
alertcondition(bullishDivergence or bearishDivergence, title='Any Divergence', message='Z-Score: Divergence detected - Trend exhaustion signal {{exchange}}:{{ticker}} - {{interval}}')

//              â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—              //
//              â•‘           CREATED BY           â•‘              //
//              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              //

// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
//â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—
//â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
//â–ˆâ–ˆâ•‘â–„â–„ â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘       â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
//â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘       â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
// â•šâ•â•â–€â–€â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•       â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•

//The Adaptive Z-Score Oscillator transforms price action into statistical significance measurements by calculating how many standard deviations the current price deviates from its moving average baseline, then dynamically adjusting threshold levels based on historical distribution patterns. Unlike traditional oscillators that rely on fixed overbought/oversold levels, this indicator employs percentile-based adaptive thresholds that automatically calibrate to changing market volatility regimes and statistical characteristics. By offering both adaptive and fixed threshold modes alongside multiple moving average types and customizable smoothing, the indicator provides traders and investors with a robust framework for identifying extreme price deviations, mean reversion opportunities, and underlying trend conditions through the visualization of price behavior within a statistical distribution context.
snapshot

ğŸŸ¢ How It Works

The indicator begins by establishing a dynamic baseline using a user-selected moving average type applied to closing prices over the specified length period, then calculates the standard deviation to measure price dispersion:
Pine ScriptÂ®

basis = ma(close, length, maType)
stdev = ta.stdev(close, length)

The core Z-Score calculation quantifies how many standard deviations the current price sits above or below the moving average basis, creating a normalized oscillator that facilitates cross-asset and cross-timeframe comparisons:
Pine ScriptÂ®

zScore = stdev != 0 ? (close - basis) / stdev : 0
smoothedZ = ma(zScore, smooth, maType)

The adaptive threshold mechanism employs percentile calculations over a historical lookback period to determine statistically significant extreme zones. Rather than using fixed levels like Â±2.0, the indicator identifies where a specified percentage of historical Z-Score readings have fallen, automatically adjusting to market regime changes:
Pine ScriptÂ®

upperThreshold = adaptive ? ta.percentile_linear_interpolation(smoothedZ, percentilePeriod, upperPercentile) : fixedUpper
lowerThreshold = adaptive ? ta.percentile_linear_interpolation(smoothedZ, percentilePeriod, lowerPercentile) : fixedLower

The visualization architecture creates a four-tier coloring system that distinguishes between extreme conditions (beyond the adaptive thresholds) and moderate conditions (between the midpoint and threshold levels), providing visual gradation of statistical significance through opacity variations and immediate recognition of distribution extremes.
snapshot

ğŸŸ¢ How to Use This Indicator

â–¶ Overbought and Oversold Identification:
The indicator identifies potential overbought conditions when the smoothed Z-Score crosses above the upper threshold, indicating that price has deviated to a statistically extreme level above its mean. Conversely, oversold conditions emerge when the Z-Score crosses below the lower threshold, signaling statistically significant downward deviation. In adaptive mode (default), these thresholds automatically adjust to the asset's historical behavior, i.e., during high volatility periods, the thresholds expand to accommodate wider price swings, while during low volatility regimes, they contract to capture smaller deviations as significant. This dynamic calibration reduce false signals that plague fixed-level oscillators when market character shifts between volatile and ranging conditions.
snapshot

â–¶ Mean Reversion Trading Applications:
The Z-Score framework excels at identifying mean reversion opportunities by highlighting when price has stretched too far from its statistical equilibrium. When the oscillator reaches extreme bearish levels (below the lower threshold with deep red coloring), it suggests price has become statistically oversold and may snap back toward the mean, presenting potential long entry opportunities for mean reversion traders. Symmetrically, extreme bullish readings (above the upper threshold with bright green coloring) indicate potential short opportunities or long exit points as price becomes statistically overbought. The moderate zones (lighter colors between midpoint and threshold) serve as early warning areas where traders can prepare for potential reversals, while exits from extreme zones (crossing back inside the thresholds) often provide confirmation that mean reversion is underway.
snapshot

â–¶ Trend and Distribution Analysis:
Beyond discrete overbought/oversold signals, the histogram's color pattern and shape reveal the underlying trend structure and distribution characteristics. Sustained periods where the Z-Score oscillates primarily in positive territory (green bars) indicate a bullish trend where price consistently trades above its moving average baseline, even if not reaching extreme levels. Conversely, predominant negative readings (red bars) suggest bearish trend conditions. The distribution shape itself provides insight into market behavior, e.g., a narrow, centered distribution clustering near zero indicates tight ranging conditions with price respecting the mean, while a wide distribution with frequent extreme readings reveals volatile trending or choppy conditions. Asymmetric distributions skewed heavily toward one side demonstrate persistent directional bias, whereas balanced distributions suggest equilibrium between bulls and bears.
snapshot

â–¶ Built-in Alerts:
Seven alert conditions enable automated monitoring of statistical extremes and trend transitions. Enter Overbought and Enter Oversold alerts trigger when the Z-Score crosses into extreme zones, providing early warnings of potential reversal setups. Exit Overbought and Exit Oversold alerts signal when price begins reverting from extremes, offering confirmation that mean reversion has initiated. Zero Cross Up and Zero Cross Down alerts identify transitions through the neutral line, indicating shifts between above-mean and below-mean price action that can signal trend changes. The Extreme Zone Entry alert fires on any extreme threshold penetration regardless of direction, allowing unified monitoring of both overbought and oversold opportunities.
snapshot

â–¶ Color Customization:
Six visual themes (Classic, Aqua, Cosmic, Ember, Neon, plus Custom) accommodate different chart backgrounds and aesthetic preferences, ensuring optimal contrast and readability across trading platforms. The bar transparency control (0-90%) allows fine-tuning of visual prominence, with minimal transparency creating bold, attention-grabbing bars for primary analysis, while higher transparency values produce subtle background context when using the oscillator alongside other indicators. The extreme and moderate zone coloring system uses automatic opacity variation to create instant visual hierarchy, with darkest colors highlight the most statistically significant deviations demanding immediate attention, while lighter shades mark developing conditions that warrant monitoring but may not yet justify action. Optional candle coloring extends the Z-Score color scheme directly to the price candles on the main chart, enabling traders to instantly recognize statistical extremes and trend conditions without needing to reference the oscillator panel, creating a unified visual experience where both price action and statistical analysis share the same color language.
snapshot

snapshot

snapshot

snapshot

snapshot

snapshot
Dec 29, 2025
Release Notes
Added divergence detection options with customizable settings, informative tooltips, 'Bull'/'Bear' visual labels, and dedicated alert conditions to identify statistical trend exhaustion signals.
Jan 1
Release Notes
Added customizable neutral color input